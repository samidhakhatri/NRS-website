"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseResponse = parseResponse;
exports.getUserFromResponse = getUserFromResponse;
exports.wrapAsync = wrapAsync;

var _utils = _interopRequireDefault(require("../utils"));

var _async = _interopRequireDefault(require("../request/async"));

var _user = _interopRequireDefault(require("./user"));

function parseResponse(data, stayLoggedIn) {
  var user = new _user["default"]();

  _utils["default"].deepExtend(user, data);

  if (stayLoggedIn) {
    this.app.LocalCache.set('stayLoggedIn', stayLoggedIn);
  }

  return user;
}

function getUserFromResponse(user) {
  this.app.LocalCache.set('current-user-id', user.objectId);
  var userToken = user['user-token'];

  if (userToken && this.app.LocalCache.get('stayLoggedIn')) {
    this.app.LocalCache.set('user-token', userToken);
  }

  return new _user["default"](user);
}

function wrapAsync(asyncHandler, stayLoggedIn) {
  var context = this;

  var success = function success(data) {
    context.setLocalCurrentUser(parseResponse.call(context, _utils["default"].tryParseJSON(data), stayLoggedIn));
    asyncHandler.success(getUserFromResponse.call(context, context.getLocalCurrentUser()));
  };

  var error = function error(data) {
    asyncHandler.fault(data);
  };

  return new _async["default"](success, error);
}